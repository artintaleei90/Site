<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>فروشگاه هالستون</title>
  <style>
    body { font-family: Tahoma, sans-serif; direction: rtl; margin:0; background:#f5f5f5;}
    header { background:#232f3e; color:#fff; padding:14px 18px; display:flex; justify-content:space-between; align-items:center;}
    header h1 { margin:0; font-size:20px;}
    header button { background:#febd69; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;}
    .container { max-width:1100px; margin:18px auto; display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:18px; padding:0 10px;}
    .product-card { background:#fff; padding:14px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.08); text-align:center;}
    .product-card img { width:100%; height:180px; object-fit:cover; border-radius:6px; }
    .product-card h3 { margin:10px 0 6px; font-size:16px;}
    .product-card p { margin:4px 0; color:#333;}
    .controls { display:flex; gap:8px; align-items:center; justify-content:center; margin-top:10px;}
    .controls button { background:#232f3e; color:#fff; border:none; width:34px; height:34px; border-radius:6px; font-size:18px; cursor:pointer;}
    .controls span { min-width:36px; text-align:center; font-weight:bold;}
    .add-btn { margin-top:10px; background:#28a745; color:#fff; padding:8px 12px; border:none; border-radius:6px; cursor:pointer;}
    /* modal */
    #cartModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;}
    #cartContent { background:#fff; width:90%; max-width:520px; border-radius:10px; padding:16px; max-height:90vh; overflow:auto;}
    #cartContent h2 { margin-top:0;}
    #cartContent ul { list-style:none; padding:0; margin:0 0 10px 0;}
    #cartContent li { padding:8px 0; border-bottom:1px solid #eee;}
    .close { float:left; cursor:pointer; background:#eee; border-radius:6px; padding:4px 8px;}
    .submit-btn { background:#232f3e; color:#fff; border:none; padding:10px; width:100%; border-radius:8px; cursor:pointer; margin-top:8px;}
    input[type="text"], input[type="tel"] { width:100%; padding:8px; margin-top:8px; border-radius:6px; border:1px solid #ccc;}
  </style>
</head>
<body>
  <header>
    <h1>فروشگاه هالستون</h1>
    <button onclick="openCart()">🛒 سبد خرید (<span id="cartCount">0</span>)</button>
  </header>

  <div class="container">
    {% for code, product in products.items() %}
    <div class="product-card" id="card-{{ code }}">
      <img src="{{ product.image if product.image is defined else 'https://via.placeholder.com/400x300?text=No+Image' }}" alt="{{ product.name }}">
      <h3>{{ product.name }}</h3>
      <p>کد: {{ code }}</p>
      <p style="color:#ff4081; font-weight:bold;">{{ "{:,}".format(product.price) }} تومان</p>

      <div class="controls">
        <button onclick="decrease('{{ code }}')">-</button>
        <span id="qty-{{ code }}">0</span>
        <button onclick="increase('{{ code }}')">+</button>
      </div>

      <button class="add-btn" onclick="addToCartFromCard('{{ code }}')">افزودن به سبد</button>
    </div>
    {% endfor %}
  </div>

  <!-- modal -->
  <div id="cartModal">
    <div id="cartContent">
      <span class="close" onclick="closeCart()">بستن ✖</span>
      <h2>سبد خرید</h2>
      <ul id="cartItems"></ul>
      <p>جمع کل: <strong id="cartTotal">0</strong> تومان</p>

      <input id="customerName" type="text" placeholder="نام و نام خانوادگی">
      <input id="customerPhone" type="tel" placeholder="شماره تماس">
      <input id="customerAddress" type="text" placeholder="آدرس کامل">

      <button class="submit-btn" onclick="submitOrder()">ثبت سفارش و دریافت فاکتور</button>
    </div>
  </div>

  <script>
    // cart: آرایه از آبجکت‌ها {code, name, price, count}
    let cart = [];

    function increase(code) {
      const qtyEl = document.getElementById('qty-' + code);
      let val = parseInt(qtyEl.textContent) || 0;
      val++;
      qtyEl.textContent = val;
    }
    function decrease(code) {
      const qtyEl = document.getElementById('qty-' + code);
      let val = parseInt(qtyEl.textContent) || 0;
      if (val > 0) val--;
      qtyEl.textContent = val;
    }

    function addToCartFromCard(code) {
      const qtyEl = document.getElementById('qty-' + code);
      let quantity = parseInt(qtyEl.textContent) || 0;
      if (quantity <= 0) {
        alert('لطفاً تعداد را انتخاب کنید');
        return;
      }
      // پیدا کردن محصول در لیست سرور از HTML (می‌توانستیم داده‌ها رو در JS هم داشته باشیم)
      const card = document.getElementById('card-' + code);
      const name = card.querySelector('h3').innerText;
      const priceText = card.querySelector('p[style]').innerText.replace(/[^0-9]/g,'');
      const price = parseInt(priceText) || 0;

      // اگر قبلا محصول وجود داشت، افزایش بده
      let existing = cart.find(i => i.code === code);
      if (existing) {
        existing.count += quantity;
      } else {
        cart.push({ code: code, name: name, price: price, count: quantity });
      }
      // ریست کردن نمایشگر کنار کارت
      qtyEl.textContent = 0;
      updateCartIndicator();
      alert('محصول به سبد اضافه شد ✅');
    }

    function updateCartIndicator() {
      const totalItems = cart.reduce((s, i) => s + i.count, 0);
      document.getElementById('cartCount').innerText = totalItems;
    }

    function openCart() {
      renderCart();
      document.getElementById('cartModal').style.display = 'flex';
    }
    function closeCart() {
      document.getElementById('cartModal').style.display = 'none';
    }

    function renderCart() {
      const ul = document.getElementById('cartItems');
      ul.innerHTML = '';
      let total = 0;
      cart.forEach((item, idx) => {
        total += item.price * item.count;
        const li = document.createElement('li');
        li.innerHTML = `
          <div>
            <strong>${item.name}</strong><br>
            کد: ${item.code} — ${item.price.toLocaleString()} تومان × ${item.count}
            <br>
            <button onclick="cartDecrease(${idx})">-</button>
            <button onclick="cartIncrease(${idx})">+</button>
            <button onclick="cartRemove(${idx})">حذف</button>
          </div>
        `;
        ul.appendChild(li);
      });
      document.getElementById('cartTotal').innerText = total.toLocaleString();
    }

    function cartIncrease(i) {
      cart[i].count++;
      renderCart();
      updateCartIndicator();
    }
    function cartDecrease(i) {
      if (cart[i].count > 1) cart[i].count--;
      else cart.splice(i,1);
      renderCart();
      updateCartIndicator();
    }
    function cartRemove(i) {
      cart.splice(i,1);
      renderCart();
      updateCartIndicator();
    }

    function submitOrder() {
      if (!cart.length) { alert('سبد خرید خالی است'); return; }
      const name = document.getElementById('customerName').value.trim();
      const phone = document.getElementById('customerPhone').value.trim();
      const address = document.getElementById('customerAddress').value.trim();
      if (!name || !phone || !address) { alert('لطفاً مشخصات را کامل کنید'); return; }

      // ساخت فرم پنهان و ارسال
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/order';

      cart.forEach(item => {
        const cInp = document.createElement('input');
        cInp.type = 'hidden';
        cInp.name = 'order_code';
        cInp.value = item.code;
        form.appendChild(cInp);

        const cntInp = document.createElement('input');
        cntInp.type = 'hidden';
        cntInp.name = 'order_count';
        cntInp.value = item.count;
        form.appendChild(cntInp);
      });

      const n = document.createElement('input'); n.type='hidden'; n.name='name'; n.value = name; form.appendChild(n);
      const p = document.createElement('input'); p.type='hidden'; p.name='phone'; p.value = phone; form.appendChild(p);
      const a = document.createElement('input'); a.type='hidden'; a.name='address'; a.value = address; form.appendChild(a);

      document.body.appendChild(form);
      form.submit();
    }
  </script>
</body>
</html>
