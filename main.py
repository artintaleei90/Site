from flask import Flask, render_template, request, send_file
from reportlab.pdfgen import canvas
from reportlab.pdfbase.ttfonts import TTFont
from reportlab.pdfbase import pdfmetrics
from reportlab.platypus import Table, TableStyle
from reportlab.lib import colors
from reportlab.lib.pagesizes import A4
from reportlab.lib.units import cm
import arabic_reshaper
from bidi.algorithm import get_display
import requests
import os

app = Flask(__name__)

# ---------------------- ูุญุตููุงุช ----------------------
products = {
    "3390": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 697000, "unit": "ูุฒุงุฑ ุชููุงู","image":"https://raw.githubusercontent.com/artintaleei90/Site/main/IMG_0394.jpeg"},
    "1107": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ุณูุฏ ู ูุดฺฉ", "price": 547000, "unit": "ูุฒุงุฑ ุชููุงู","image":"https://raw.githubusercontent.com/artintaleei90/Site/main/IMG_0395.jpeg"},
    "1303": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 4 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ ุจู ุฌุฒ ุณุจุฒ", "price": 747000, "unit": "ูุฒุงุฑ ุชููุงู","image":"https://raw.githubusercontent.com/artintaleei90/Site/main/IMG_0396.jpeg"},
    "3389": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 4 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ (ูุงูุชู ฺฉุช)", "price": 797000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "1106": {"name": "ูุฑ ุณุงุฒ - ุฏู ุทุฑุญ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 397000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "1203": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ุณูุฏ", "price": 547000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "1213": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 497000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "3392": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ (ฺฉุฑู ู ูุดฺฉ)", "price": 597000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "3357": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 5 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 427000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "1108": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 647000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "3346": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 597000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "1204": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 5 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 597000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "3340": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 567000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "1114": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 7 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ (PERRY ุชุฑฺฉ)", "price": 637000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "1102": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 5 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 397000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "1301": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 4 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 597000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "3377": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 597000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "3759": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 347000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "1117": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 697000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "3395": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 757000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "3364": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 457000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "1201": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 4 ุนุฏุฏ ุฑูฺฏ: ฺฉุฑู", "price": 797000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "3383": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 657000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "1202": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 737000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "1211": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 567000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "3345": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 597000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "3752": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 347000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "3356": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 697000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "1209": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 497000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "1208": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 7 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 397000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "1305": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 4 ุนุฏุฏ ุฑูฺฏ: ููุท ฺฏู ูุฑูุฒ", "price": 517000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "3353": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 417000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "1210": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 657000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "3370": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 697000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "1302": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ ุจุง ุณูุฏ ู ูุดฺฉ ุฏูุจู", "price": 497000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "3325": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 4 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 497000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "3781": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 4 ุนุฏุฏ ุฑูฺฏ: ูุดฺฉ", "price": 397000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "3341": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ูุดฺฉ", "price": 637000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "3379": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 4 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 697000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "1105": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 737000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "3381": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 4 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ (ููุงุจ ุจุงู ุณุจฺฉ)", "price": 597000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "3762": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ (ุฌูุณ ูพุงุฑฺู ุฏุฑ ุชุตูุฑ ุฑูฺฏุจูุฏ)", "price": 697000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "3384": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ูุดฺฉ ุณุจุฒ ุทูุณ", "price": 647000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "1111": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 5 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 797000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "1306": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 5 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 597000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "3329": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 5 ุนุฏุฏ ุฑูฺฏ: ุณู ุฑูฺฏ ุจุง ุณูุฏ ูุดฺฉ ุฏูุจู", "price": 557000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "3791": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 597000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "3348": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 8 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 297000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "3494": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 497000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "3394": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 957000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "1116": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 4 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 647000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "1112": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 4 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 597000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "3393": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 597000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "1115": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 6 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 547000, "unit": "ูุฒุงุฑ ุชููุงู"},
    "1118": {"name": "ูุฑ ุณุงุฒ - ูพฺฉ 4 ุนุฏุฏ ุฑูฺฏ: ุฏุฑ ุชุตูุฑ", "price": 697000, "unit": "ูุฒุงุฑ ุชููุงู"}
}

# ุงุทูุงุนุงุช ูุฏุฑ ุจุฑุง ุงุฑุณุงู PDF
ADMIN_CHAT_ID = 6933858510
TELEGRAM_TOKEN = "7739258515:AAEUXIZ3ySZ9xp9W31l7qr__sZkbf6qcKnE"

# ุซุจุช ูููุช ูุงุฑุณ
FONT_PATH = "Vazirmatn-Regular.ttf"
if not os.path.exists(FONT_PATH):
    raise Exception("ูููุช ูุงุฑุณ ูพุฏุง ูุดุฏ! ูุทูุง Vazirmatn-Regular.ttf ุฑุง ฺฉูุงุฑ ูุงู ูุฑุงุฑ ุจุฏู.")
pdfmetrics.registerFont(TTFont('Vazir', FONT_PATH))

def reshape_text(text):
    return get_display(arabic_reshaper.reshape(text))

# ---------------------- ุฑูุช ุงุตู ----------------------
@app.route('/')
def index():
    return render_template("index.html", products=products)

# ---------------------- ุซุจุช ุณูุงุฑุด ----------------------
@app.route('/order', methods=['POST'])
def order():
    name = request.form.get("name")
    phone = request.form.get("phone")
    address = request.form.get("address")
    order_codes = request.form.getlist("order_code")
    order_counts = request.form.getlist("order_count")

    filename = f"invoice_{phone}.pdf"
    c = canvas.Canvas(filename, pagesize=A4)
    width, height = A4
    y_start = height - 2*cm

    # ุนููุงู ูุงฺฉุชูุฑ
    c.setFont("Vazir", 16)
    c.drawCentredString(width/2, y_start, reshape_text("๐งพ ูุงฺฉุชูุฑ ุณูุงุฑุด"))
    y = y_start - 2*cm

    # ุงุทูุงุนุงุช ูุดุชุฑ
    c.setFont("Vazir", 12)
    c.drawRightString(width - 2*cm, y, reshape_text(f"ูุงู ูุดุชุฑ: {name}"))
    y -= 1*cm
    c.drawRightString(width - 2*cm, y, reshape_text(f"ุดูุงุฑู ุชูุงุณ: {phone}"))
    y -= 1*cm
    c.drawRightString(width - 2*cm, y, reshape_text(f"ุขุฏุฑุณ: {address}"))
    y -= 1.5*cm

    # ุฌุฏูู ูุญุตููุงุช
    table_data = [
        [reshape_text("ฺฉุฏ ูุญุตูู"), reshape_text("ูุงู ูุญุตูู"), reshape_text("ุชุนุฏุงุฏ"), reshape_text("ููุช ูุงุญุฏ"), reshape_text("ูุจูุบ ฺฉู")]
    ]
    total = 0
    for code, count in zip(order_codes, order_counts):
        count = int(count)
        product = products.get(code)
        if product:
            price = product["price"]
            sum_price = price * count
            total += sum_price
            table_data.append([
                reshape_text(code),
                reshape_text(product["name"]),
                reshape_text(str(count)),
                reshape_text(str(price)),
                reshape_text(str(sum_price))
            ])

    table = Table(table_data, colWidths=[3*cm, 7*cm, 2*cm, 3*cm, 3*cm])
    style = TableStyle([
        ('GRID', (0,0), (-1,-1), 1, colors.black),
        ('BACKGROUND', (0,0), (-1,0), colors.lightgrey),
        ('FONTNAME', (0,0), (-1,-1), 'Vazir'),
        ('FONTSIZE', (0,0), (-1,-1), 10),
        ('ALIGN', (0,0), (-1,-1), 'CENTER'),
        ('BOTTOMPADDING', (0,0), (-1,0), 12),
    ])
    table.setStyle(style)
    table.wrapOn(c, width, height)
    table.drawOn(c, 2*cm, y - len(table_data)*1.2*cm)
    y -= (len(table_data)*1.2*cm + 1*cm)

    # ุฌูุน ฺฉู ู ุชูุถุญุงุช ูพุฑุฏุงุฎุช
    c.drawRightString(width - 2*cm, y, reshape_text(f"ุฌูุน ฺฉู: {total} ุชููุงู"))
    y -= 1*cm
    payment_text = ("ุจุงูฺฉ ุณุงูุงู - ุขุฒุชุง ูุชูุญ ูุธูุฑูฺุงุฏ 6219-8610-6509-3089 "
                    "IR440560083280078294010001. ูุงุฑุฒ ูุฌู ุชููุง ุจู ุดูุงุฑู ฺฉุงุฑุช ูุง ุฏุฑุงูุช ุงุฒ ุดูุงุฑู ุชูุงุณ 09128883343 ุฏุงุฑุง ุงุนุชุจุงุฑ ู ุจุงุดุฏ. "
                    "ููฺฉุงุฑ ฺฏุฑุงู ุชููุง ูพุณ ุงุฒ ุชุงุฏ ูุฌู ุฏุฑ ุจุงูฺฉ ููุตุฏุ ุงูฺฉุงู ุฎุฑูุฌ ุงุฒ ุงูุจุงุฑ ูุณุฑ ุงุณุช. "
                    "ูุฐุง ุฎูุงูุดููุฏู ูุณุจุช ุจู ุงูุชูุงู ูุฌู ุจู ุตูุฑุช ฺฉุงุฑุช ุจู ฺฉุงุฑุชุ ุดุจุงุ ูพุงุง ... ุชูุฌู ูุฑูุงุฏ.")
    c.setFont("Vazir", 10)
    c.drawRightString(width - 2*cm, y, reshape_text(payment_text))

    c.save()

    # ุงุฑุณุงู PDF ุจู ูุฏุฑ
    url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendDocument"
    with open(filename, "rb") as f:
        requests.post(url, data={"chat_id": ADMIN_CHAT_ID}, files={"document": f})

    # ููุงุด PDF ุจู ฺฉุงุฑุจุฑ
    return send_file(filename, as_attachment=True)

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)
